name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Import GPG key
        run: |
          set -euo pipefail

          raw_key="${GPG_PRIVATE_KEY:-${GPGPRIVATEKEY:-}}"
          raw_key_b64="${GPG_PRIVATE_KEY_BASE64:-${GPGPRIVATEKEY_BASE64:-}}"

          if [ -z "${raw_key}" ] && [ -z "${raw_key_b64}" ]; then
            echo "GPG key secret is empty. Set GPG_PRIVATE_KEY/GPG_PRIVATE_KEY_BASE64 or GPGPRIVATEKEY/GPGPRIVATEKEY_BASE64."
            exit 1
          fi

          imported=0
          b64_file="$(mktemp)"
          raw_file="$(mktemp)"

          # Try dedicated BASE64 secret first (binary export recommended).
          if [ -n "${raw_key_b64}" ]; then
            if printf '%s' "${raw_key_b64}" | base64 --decode > "${b64_file}" 2>/dev/null; then
              if [ -s "${b64_file}" ] && gpg --batch --import "${b64_file}" >/dev/null 2>&1; then
                imported=1
              fi
            fi
          fi

          # Fallback: raw secret (multiline armored, \n-escaped armored, or base64 text).
          if [ "${imported}" -eq 0 ] && [ -n "${raw_key}" ]; then
            printf '%b' "${raw_key}" > "${raw_file}"
            if [ -s "${raw_file}" ] && gpg --batch --import "${raw_file}" >/dev/null 2>&1; then
              imported=1
            else
              # Some users store base64 in the raw secret; try decoding it.
              if printf '%s' "${raw_key}" | base64 --decode > "${raw_file}" 2>/dev/null; then
                if [ -s "${raw_file}" ] && gpg --batch --import "${raw_file}" >/dev/null 2>&1; then
                  imported=1
                fi
              fi
            fi
          fi

          if [ "${imported}" -eq 0 ]; then
            echo "No valid OpenPGP private key could be imported from provided secrets."
            echo "Use GPG_PRIVATE_KEY_BASE64 (preferred) from binary export, or a valid armored GPG_PRIVATE_KEY."
            exit 1
          fi

          gpg --batch --list-secret-keys --keyid-format LONG
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PRIVATE_KEY_BASE64: ${{ secrets.GPG_PRIVATE_KEY_BASE64 }}
          GPGPRIVATEKEY: ${{ secrets.GPGPRIVATEKEY }}
          GPGPRIVATEKEY_BASE64: ${{ secrets.GPGPRIVATEKEY_BASE64 }}

      - name: Normalize signing key id
        run: |
          set -euo pipefail
          signing_id="${GPG_SIGNING_KEY_ID:-${GPGSIGNINGKEYID:-}}"
          if [ -z "${signing_id}" ]; then
            echo "GPG signing key id is empty. Set GPG_SIGNING_KEY_ID or GPGSIGNINGKEYID."
            exit 1
          fi
          echo "GPG_SIGNING_KEY_ID=${signing_id}" >> "${GITHUB_ENV}"
        env:
          GPG_SIGNING_KEY_ID: ${{ secrets.GPG_SIGNING_KEY_ID }}
          GPGSIGNINGKEYID: ${{ secrets.GPGSIGNINGKEYID }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_SIGNING_KEY_ID: ${{ secrets.GPG_SIGNING_KEY_ID }}
